<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Tienda WhatsApp | Premium</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@700;800&display=swap">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #121212;
            --accent: #b08d57;
            --text: #1a1a1a;
            --text-light: #757575;
            --bg: #fdfdfd;
            --white: #FFFFFF;
            --border: #eeeeee;
            --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
        }

        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; }

        /* Header */
        .header { background: rgba(255, 255, 255, 0.8); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 1.25rem 0; position: sticky; top: 0; z-index: 1000; }
        .header-content { max-width: 1300px; margin: 0 auto; padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .logo-section { display: flex; align-items: center; gap: 0.8rem; text-decoration: none; color: inherit; }
        .logo { width: 42px; height: 42px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: var(--white); }
        .store-name { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 800; }

        /* Buttons */
        .btn { padding: 0.8rem 1.6rem; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.6rem; font-family: inherit; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--accent); transform: translateY(-2px); }
        .btn-secondary { background: #f5f5f7; color: var(--text); }
        .cart-btn { position: relative; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--accent); color: white; min-width: 20px; height: 20px; border-radius: 10px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; border: 2px solid white; font-weight: 800; }

        .container { max-width: 1300px; margin: 0 auto; padding: 4rem 1.5rem; }

        /* Admin Panel */
        .admin-panel { background: var(--white); border-radius: 32px; padding: 3rem; margin-bottom: 4rem; box-shadow: var(--shadow-lg); border: 1px solid rgba(0,0,0,0.03); }
        .admin-title { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin-bottom: 2.5rem; text-align: center; }
        
        .tabs { display: flex; gap: 1rem; margin-bottom: 3rem; padding: 0.5rem; background: #f5f5f7; border-radius: 20px; overflow-x: auto; scrollbar-width: none; }
        .tab { padding: 0.8rem 1.5rem; background: transparent; border: none; font-weight: 600; border-radius: 15px; cursor: pointer; color: var(--text-light); transition: 0.3s; white-space: nowrap; }
        .tab.active { background: var(--white); color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.5s ease forwards; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Forms */
        .form-group { margin-bottom: 1.8rem; }
        label { display: block; margin-bottom: 0.7rem; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.08em; }
        input, select, textarea { width: 100%; padding: 1rem; border: 1px solid #e1e1e1; border-radius: 14px; font-size: 1rem; font-family: 'Outfit', sans-serif; background: #fcfcfc; }
        input:focus { outline: none; border-color: var(--accent); background: white; box-shadow: 0 0 0 4px rgba(176, 141, 87, 0.1); }

        /* Product Cards */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2.5rem; }
        .product-card { background: var(--white); border-radius: 28px; overflow: hidden; transition: 0.4s; border: 1px solid rgba(0,0,0,0.04); display: flex; flex-direction: column; }
        .product-card:hover { transform: translateY(-10px); box-shadow: var(--shadow-lg); }
        .product-image { width: 100%; height: 320px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-content { padding: 2rem; flex-grow: 1; display: flex; flex-direction: column; }
        .product-price { font-size: 1.6rem; font-weight: 700; margin: 1rem 0; color: var(--primary); }

        /* Variant Options */
        .variant-option { padding: 0.6rem 1.2rem; border: 1px solid #eee; border-radius: 12px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: 0.2s; }
        .variant-option.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Preview Images */
        .image-preview-item { position: relative; width: 80px; height: 80px; border-radius: 12px; overflow: hidden; border: 1px solid #eee; }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-img { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; }

        /* Alerts */
        .alert { position: fixed; bottom: 2rem; right: 2rem; padding: 1.2rem 2.5rem; border-radius: 20px; background: var(--primary); color: white; box-shadow: var(--shadow-lg); z-index: 4000; animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .hidden { display: none !important; }

        /* Modal Carrito */
        .cart-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 2000; justify-content: center; align-items: center; }
        .cart-modal.active { display: flex; }
        .cart-content { background: white; width: 100%; max-width: 500px; border-radius: 35px; padding: 3rem; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <a href="#" class="logo-section" onclick="location.reload()">
                <div class="logo" id="logoDisplay">üõí</div>
                <h1 class="store-name" id="storeNameDisplay">Mi Tienda</h1>
            </a>
            <div class="header-actions">
                <button class="btn btn-secondary" id="adminToggle">‚öôÔ∏è Panel</button>
                <button class="btn btn-primary cart-btn" id="cartBtn">
                    üõí <span class="hidden sm:inline">Carrito</span>
                    <span class="cart-badge" id="cartBadge">0</span>
                </button>
            </div>
        </div>
    </header>

    <div id="loginModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 5000; backdrop-filter: blur(15px);">
        <div style="background: white; padding: 4rem 3rem; border-radius: 40px; max-width: 450px; width: 90%; text-align: center;">
            <div style="font-size: 3.5rem; margin-bottom: 1.5rem;">üîê</div>
            <h2 style="font-family: 'Playfair Display', serif; font-size: 2.2rem; margin-bottom: 2rem;">Acceso Privado</h2>
            <div id="loginForm">
                <input type="password" id="loginPassword" placeholder="Tu clave" style="text-align: center; margin-bottom: 1.5rem;">
                <button class="btn btn-primary" onclick="attemptLogin()" style="width: 100%;">Entrar</button>
                <a href="?shop=customer" style="display: block; margin-top: 2rem; color: #757575; text-decoration: none;">Ver como cliente</a>
            </div>
            <div id="setupForm" class="hidden">
                <p style="margin-bottom: 2rem;">Configura tu contrase√±a de administrador.</p>
                <input type="password" id="setupPassword1" placeholder="Nueva clave" style="margin-bottom: 1rem;">
                <input type="password" id="setupPassword2" placeholder="Repite clave" style="margin-bottom: 1.5rem;">
                <button class="btn btn-primary" onclick="setupPassword()" style="width: 100%;">Guardar</button>
            </div>
            <div id="loginError" class="hidden" style="color: #dc2626; margin-top: 1.5rem;"></div>
        </div>
    </div>

    <div class="container">
        <div class="admin-panel hidden" id="adminPanel">
            <h2 class="admin-title">Configuraci√≥n</h2>
            <div class="tabs">
                <button class="tab active" data-tab="design">üé® Tienda</button>
                <button class="tab" data-tab="products">üì¶ Productos</button>
                <button class="tab" data-tab="categories">üìë Categor√≠as</button>
                <button class="tab" data-tab="coupons">üéÅ Cupones</button>
                <button class="tab" data-tab="share">üîó Enlace</button>
                <button class="tab" data-tab="data">üíæ Backup</button>
            </div>

            <div class="tab-content active" id="design">
                <div class="form-group"><label>Nombre Tienda</label><input type="text" id="storeName"></div>
                <div class="form-group"><label>WhatsApp (Ej: +34600000000)</label><input type="text" id="whatsappNumber"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group"><label>Color</label><input type="color" id="primaryColor" style="height: 55px;"></div>
                    <div class="form-group">
                        <label>Moneda del Mundo</label>
                        <select id="currencySymbol"></select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveDesign()" style="width: 100%;">üíæ Guardar Cambios</button>
            </div>

            <div class="tab-content" id="products">
                <div class="form-group"><label>Nombre del Producto</label><input type="text" id="productName"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group"><label>Precio</label><input type="number" id="productPrice" step="0.01"></div>
                    <div class="form-group"><label>Categor√≠a</label><select id="productCategory"></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="productDescription" rows="2"></textarea></div>
                <div class="form-group">
                    <label>Im√°genes del Producto (Se acumulan al subir)</label>
                    <input type="file" id="productImageFile" accept="image/*" multiple style="margin-bottom: 1rem;">
                    <div id="imagesPreview" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                </div>
                <div class="form-group">
                    <label>Variantes (Tallas, Colores...) + Im√°genes por opci√≥n</label>
                    <div id="variantsContainer"></div>
                    <button class="btn btn-secondary" onclick="addVariantGroup()">+ Nuevo Grupo (Talla, Color...)</button>
                </div>
                <button class="btn btn-primary" onclick="addProduct()" style="width: 100%;">‚ûï Publicar Producto</button>
                <div id="productsList" style="margin-top: 3rem;"></div>
            </div>

            <div class="tab-content" id="categories">
                <div class="form-group"><label>Nombre Categor√≠a</label><input type="text" id="newCategory"></div>
                <button class="btn btn-primary" onclick="addCategory()">A√±adir</button>
                <div id="categoriesList" style="margin-top: 2rem;"></div>
            </div>
            <div class="tab-content" id="coupons">
                <input type="text" id="couponCode" placeholder="C√ìDIGO" style="margin-bottom: 1rem;">
                <input type="number" id="couponValue" placeholder="VALOR">
                <button class="btn btn-primary" onclick="addCoupon()" style="margin-top: 1rem;">Crear Cup√≥n</button>
                <div id="couponsList" style="margin-top: 2rem;"></div>
            </div>
            <div class="tab-content" id="share">
                <div style="text-align: center; border: 2px dashed #eee; padding: 2rem; border-radius: 20px;">
                    <input type="text" id="shareLink" readonly style="text-align: center; margin-bottom: 1.5rem;">
                    <div id="qrcode" style="display: flex; justify-content: center; margin-bottom: 1.5rem;"></div>
                    <button class="btn btn-primary" onclick="copyLink()">Copiar Enlace</button>
                </div>
            </div>
            <div class="tab-content" id="data">
                <button class="btn btn-primary" onclick="exportData()" style="width: 100%; margin-bottom: 1rem;">Exportar JSON</button>
                <input type="file" id="importFile" accept=".json">
                <button class="btn btn-secondary" onclick="importData()" style="width: 100%; margin-top: 1rem;">Importar Datos</button>
                <button class="btn btn-secondary" onclick="resetData()" style="width: 100%; margin-top: 3rem; color: red;">BORRAR TODO</button>
            </div>
        </div>

        <div id="productsDisplay"></div>
    </div>

    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <h3 style="font-family: 'Playfair Display'; font-size: 2rem; margin-bottom: 2rem;">Tu Pedido</h3>
            <div id="customerForm" class="hidden">
                <input type="text" id="customerName" placeholder="Tu Nombre" style="margin-bottom: 1rem;">
                <input type="text" id="customerPhone" placeholder="Tu Tel√©fono" style="margin-bottom: 1rem;">
                <textarea id="customerAddress" placeholder="Direcci√≥n de Env√≠o" style="margin-bottom: 2rem;"></textarea>
            </div>
            <div id="cartItems"></div>
            <div id="cartTotal" class="hidden">
                <div style="display: flex; gap: 1rem; margin: 2rem 0;">
                    <input type="text" id="couponInput" placeholder="CUP√ìN">
                    <button class="btn btn-secondary" onclick="applyCoupon()">Aplicar</button>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 1.8rem;">
                    <span>Total:</span><span id="total">0.00</span>
                </div>
                <button class="btn btn-primary" onclick="sendWhatsApp()" style="width: 100%; margin-top: 2rem; padding: 1.5rem;">Pedir por WhatsApp</button>
                <button class="btn btn-secondary" onclick="closeCart()" style="width: 100%; margin-top: 1rem;">Cerrar</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 4rem; color: #888;">&copy; 2026 Cat√°logo WhatsApp Premium</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Listado Exhaustivo de Monedas
        const currencies = [
            {s:"‚Ç¨", n:"Euro (EUR)"}, {s:"$", n:"D√≥lar (USD)"}, {s:"¬£", n:"Libra (GBP)"}, {s:"¬•", n:"Yen (JPY)"}, {s:"$", n:"Peso Mex (MXN)"},
            {s:"$", n:"Peso Arg (ARS)"}, {s:"$", n:"Peso Col (COP)"}, {s:"$", n:"Peso Chi (CLP)"}, {s:"S/.", n:"Sol (PEN)"}, {s:"Bs", n:"Boliviano (BOB)"},
            {s:"‚Ç≤", n:"Guaran√≠ (PYG)"}, {s:"$", n:"Peso Uru (UYU)"}, {s:"‚Ç°", n:"Col√≥n (CRC)"}, {s:"L", n:"Lempira (HNL)"}, {s:"Q", n:"Quetzal (GTQ)"},
            {s:"C$", n:"C√≥rdoba (NIO)"}, {s:"B/.", n:"Balboa (PAB)"}, {s:"R$", n:"Real (BRL)"}, {s:"$", n:"D√≥lar Can (CAD)"}, {s:"$", n:"D√≥lar Aus (AUD)"},
            {s:"CHF", n:"Franco Suizo"}, {s:"kr", n:"Corona Sueca"}, {s:"NZ$", n:"D√≥lar NZ"}, {s:"CN¬•", n:"Yuan (CNY)"}, {s:"‚Çπ", n:"Rupia (INR)"},
            {s:"‚ÇΩ", n:"Rublo (RUB)"}, {s:"‚Ç©", n:"Won (KRW)"}, {s:"‚Ç∫", n:"Lira Turca"}, {s:"R", n:"Rand (ZAR)"}, {s:"‚Ç™", n:"Shekel (ILS)"}
            // ... se pueden a√±adir m√°s din√°micamente si es necesario
        ];

        let storeData = {
            name: 'Mi Tienda', logo: 'üõí', primaryColor: '#121212', currency: '‚Ç¨', 
            whatsapp: '', auth: { passwordHash: null, isAuthenticated: false },
            products: [], categories: ['General'], coupons: [], cart: [], appliedCoupon: null
        };

        let variantGroupCounter = 0;
        let tempProductImages = [];

        function init() {
            loadData();
            populateCurrencies();
            updateDisplay();
            initializeTabs();
            generateShareLink();
            setupImagePreview();
            
            const params = new URLSearchParams(window.location.search);
            if (params.get('shop') === 'customer') document.getElementById('adminToggle').classList.add('hidden');
            else checkAdminAccess();
        }

        function populateCurrencies() {
            const select = document.getElementById('currencySymbol');
            currencies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.s;
                opt.textContent = `${c.s} - ${c.n}`;
                select.appendChild(opt);
            });
            select.value = storeData.currency;
        }

        function setupImagePreview() {
            const fileInput = document.getElementById('productImageFile');
            const previewContainer = document.getElementById('imagesPreview');

            fileInput.addEventListener('change', function(e) {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imgData = event.target.result;
                        tempProductImages.push(imgData);
                        renderImagePreviews();
                    };
                    reader.readAsDataURL(file);
                });
                fileInput.value = ""; // Limpiar input para permitir subir la misma otra vez
            });
        }

        function renderImagePreviews() {
            const previewContainer = document.getElementById('imagesPreview');
            previewContainer.innerHTML = '';
            tempProductImages.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = 'image-preview-item';
                div.innerHTML = `<img src="${img}"><button class="remove-img" onclick="removeTempImg(${idx})">‚úï</button>`;
                previewContainer.appendChild(div);
            });
        }

        function removeTempImg(idx) {
            tempProductImages.splice(idx, 1);
            renderImagePreviews();
        }

        function addVariantGroup() {
            const id = variantGroupCounter++;
            const div = document.createElement('div');
            div.className = 'variant-builder';
            div.style.cssText = 'background: #f8f8f8; padding: 1.5rem; border-radius: 20px; margin-bottom: 1.5rem; border: 1px solid #eee;';
            div.id = `v-group-${id}`;
            div.innerHTML = `
                <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                    <input type="text" placeholder="Nombre (Ej: Color)" class="v-name" style="flex:1">
                    <button onclick="this.parentElement.parentElement.remove()" style="border:none; background:none; cursor:pointer;">‚úï</button>
                </div>
                <div class="v-options-list" style="display:grid; gap:0.5rem; margin-bottom:1rem;"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:0.5rem;">
                    <input type="text" placeholder="Opci√≥n (Rojo)" class="v-opt-in">
                    <select class="v-opt-img">
                        <option value="">Sin imagen propia</option>
                        ${tempProductImages.map((img, i) => `<option value="${i}">Imagen ${i+1}</option>`).join('')}
                    </select>
                    <button class="btn btn-secondary" onclick="addVariantOption(${id})">A√±adir</button>
                </div>
            `;
            document.getElementById('variantsContainer').appendChild(div);
        }

        function addVariantOption(id) {
            const group = document.getElementById(`v-group-${id}`);
            const input = group.querySelector('.v-opt-in');
            const imgSelect = group.querySelector('.v-opt-img');
            const list = group.querySelector('.v-options-list');
            if(!input.value) return;

            const imgIdx = imgSelect.value;
            const imgSrc = imgIdx !== "" ? tempProductImages[imgIdx] : null;

            const tag = document.createElement('div');
            tag.style.cssText = 'background: white; border: 1px solid #ddd; padding: 0.8rem; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; font-weight: 600;';
            tag.dataset.img = imgSrc || "";
            tag.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    ${imgSrc ? `<img src="${imgSrc}" style="width:30px; height:30px; object-fit:cover; border-radius:5px;">` : 'üìÑ'}
                    <span>${input.value}</span>
                </div>
                <button onclick="this.parentElement.remove()" style="border:none; background:none; cursor:pointer;">‚úï</button>
            `;
            list.appendChild(tag);
            input.value = '';
        }

        function addProduct() {
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            if(!name || isNaN(price)) return showAlert('‚ö†Ô∏è Completa los campos', 'info');

            const variants = [];
            document.querySelectorAll('.variant-builder').forEach(g => {
                const vName = g.querySelector('.v-name').value;
                const opts = Array.from(g.querySelectorAll('.v-options-list > div')).map(div => ({
                    name: div.querySelector('span').textContent,
                    image: div.dataset.img || null
                }));
                if(vName && opts.length) variants.push({ name: vName, options: opts });
            });

            const p = {
                id: Date.now(),
                name,
                category: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                price,
                image: tempProductImages[0] || 'üì¶',
                images: [...tempProductImages],
                variants
            };

            storeData.products.push(p);
            saveData();
            updateDisplay();
            resetForm();
            showAlert('‚úÖ Producto publicado', 'success');
        }

        function displayProducts() {
            const display = document.getElementById('productsDisplay');
            if(!storeData.products.length) return display.innerHTML = '<div style="text-align:center; padding: 4rem; color: #999;">Cat√°logo vac√≠o</div>';
            
            const cats = {};
            storeData.products.forEach(p => { if(!cats[p.category]) cats[p.category] = []; cats[p.category].push(p); });

            display.innerHTML = Object.keys(cats).map(cat => `
                <section style="margin-bottom: 5rem;">
                    <h2 style="font-family:'Playfair Display'; font-size: 2.5rem; margin-bottom: 3rem; text-align:center;">${cat}</h2>
                    <div class="products-grid">
                        ${cats[cat].map(p => {
                            const isImg = p.image.startsWith('http') || p.image.startsWith('data:');
                            return `
                            <article class="product-card" id="card-${p.id}">
                                <div class="product-image">${isImg ? `<img id="main-img-${p.id}" src="${p.image}">` : p.image}</div>
                                <div class="product-content">
                                    <h3 style="font-family:'Playfair Display'; font-size:1.4rem;">${p.name}</h3>
                                    <div class="product-price">${storeData.currency}${p.price.toFixed(2)}</div>
                                    ${p.variants.map(v => `
                                        <div style="margin-bottom:1rem">
                                            <span style="font-size:0.7rem; font-weight:800; color:#999">${v.name.toUpperCase()}</span>
                                            <div class="variant-options" style="display:flex; gap:0.5rem; margin-top:0.3rem;">
                                                ${v.options.map((o, idx) => `
                                                    <div class="variant-option ${idx === 0 ? 'selected' : ''}" 
                                                         onclick="selectVarOption(this, ${p.id}, '${o.image || p.image}')">${o.name}</div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                    <button class="btn btn-primary" onclick="addToCart(${p.id})" style="width:100%; margin-top:1rem;">A√±adir al Carrito</button>
                                    ${storeData.auth.isAuthenticated ? `<button class="btn btn-secondary" onclick="deleteProduct(${p.id})" style="margin-top:0.5rem; color:red;">Eliminar</button>` : ''}
                                </div>
                            </article>`;
                        }).join('')}
                    </div>
                </section>
            `).join('');
        }

        function selectVarOption(el, pid, img) {
            el.parentElement.querySelectorAll('.variant-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            if(img && img !== "undefined") {
                const imgEl = document.getElementById(`main-img-${pid}`);
                if(imgEl) imgEl.src = img;
            }
        }

        // --- Funciones de L√≥gica Base (Permanecen del original) ---

        function loadData() {
            const saved = localStorage.getItem('storeData');
            if(saved) storeData = {...storeData, ...JSON.parse(saved)};
        }
        function saveData() { localStorage.setItem('storeData', JSON.stringify(storeData)); }

        async function attemptLogin() {
            const pass = document.getElementById('loginPassword').value;
            const hash = await hashPassword(pass);
            if(hash === storeData.auth.passwordHash) {
                sessionStorage.setItem('adminAuthenticated', 'true');
                storeData.auth.isAuthenticated = true;
                location.reload();
            } else showAlert('‚ùå Incorrecta', 'info');
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function saveDesign() {
            storeData.name = document.getElementById('storeName').value;
            storeData.whatsapp = document.getElementById('whatsappNumber').value;
            storeData.primaryColor = document.getElementById('primaryColor').value;
            storeData.currency = document.getElementById('currencySymbol').value;
            saveData();
            location.reload();
        }

        function addToCart(pid) {
            const p = storeData.products.find(x => x.id === pid);
            const vars = {};
            document.querySelectorAll(`#card-${pid} .selected`).forEach((el, idx) => {
                const groupName = p.variants[idx].name;
                vars[groupName] = el.textContent;
            });
            storeData.cart.push({ productId: pid, variants: vars, quantity: 1 });
            updateCartBadge();
            saveData();
            showAlert('üõí A√±adido', 'success');
        }

        function updateCartBadge() {
            document.getElementById('cartBadge').textContent = storeData.cart.length;
        }

        function sendWhatsApp() {
            const name = document.getElementById('customerName').value;
            const addr = document.getElementById('customerAddress').value;
            if(!name || !addr) return showAlert('‚ö†Ô∏è Faltan datos', 'info');
            let msg = `*NUEVO PEDIDO - ${storeData.name}*\nCliente: ${name}\nDirecci√≥n: ${addr}\n\n`;
            storeData.cart.forEach(i => {
                const p = storeData.products.find(x => x.id === i.productId);
                msg += `‚Ä¢ ${p.name} (${Object.values(i.variants).join('/')}) - ${storeData.currency}${p.price}\n`;
            });
            msg += `\n*Total: ${document.getElementById('total').textContent}*`;
            window.open(`https://wa.me/${storeData.whatsapp.replace(/\+/g,'')}?text=${encodeURIComponent(msg)}`);
        }

        // --- Funciones Auxiliares ---
        function checkAdminAccess() {
            if(!storeData.auth.passwordHash) showModal('setup');
            else if(sessionStorage.getItem('adminAuthenticated') === 'true') {
                storeData.auth.isAuthenticated = true;
                document.getElementById('adminPanel').classList.remove('hidden');
            } else showModal('login');
        }
        function showModal(t) { document.getElementById('loginModal').classList.remove('hidden'); if(t==='setup') document.getElementById('setupForm').classList.remove('hidden'); }
        async function setupPassword() {
            const p1 = document.getElementById('setupPassword1').value;
            if(p1.length < 6) return showAlert('‚ö†Ô∏è M√≠nimo 6', 'info');
            storeData.auth.passwordHash = await hashPassword(p1);
            saveData();
            location.reload();
        }
        function initializeTabs() {
            document.querySelectorAll('.tab').forEach(t => {
                t.addEventListener('click', () => {
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    t.classList.add('active');
                    document.getElementById(t.dataset.tab).classList.add('active');
                });
            });
        }
        function updateDisplay() {
            document.getElementById('storeNameDisplay').textContent = storeData.name;
            displayProducts();
            document.getElementById('productCategory').innerHTML = storeData.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            updateCartBadge();
        }
        function showAlert(m, t) {
            const a = document.createElement('div'); a.className = 'alert'; a.textContent = m;
            document.body.appendChild(a); setTimeout(() => a.remove(), 3000);
        }
        function resetForm() { tempProductImages = []; renderImagePreviews(); document.getElementById('variantsContainer').innerHTML = ''; }
        function openCart() { document.getElementById('cartModal').classList.add('active'); renderCart(); }
        function closeCart() { document.getElementById('cartModal').classList.remove('active'); }
        function renderCart() {
            const cont = document.getElementById('cartItems');
            if(!storeData.cart.length) { cont.innerHTML = 'Vac√≠o'; return; }
            document.getElementById('cartTotal').classList.remove('hidden');
            document.getElementById('customerForm').classList.remove('hidden');
            let total = 0;
            cont.innerHTML = storeData.cart.map((i, idx) => {
                const p = storeData.products.find(x => x.id === i.productId);
                total += p.price;
                return `<div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                    <span>${p.name} (${Object.values(i.variants).join(',')})</span>
                    <span>${storeData.currency}${p.price} <button onclick="removeFromCart(${idx})">‚úï</button></span>
                </div>`;
            }).join('');
            document.getElementById('total').textContent = storeData.currency + total.toFixed(2);
        }
        function removeFromCart(idx) { storeData.cart.splice(idx,1); renderCart(); updateCartBadge(); saveData(); }
        function generateShareLink() { document.getElementById('shareLink').value = window.location.origin + window.location.pathname + '?shop=customer'; }
        
        window.addEventListener('load', init);
        document.getElementById('cartBtn').addEventListener('click', openCart);
        document.getElementById('adminToggle').addEventListener('click', () => document.getElementById('adminPanel').classList.toggle('hidden'));
    </script>
</body>
</html>
